<!-- backend/public/admin.html -->
<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ORE - Admin de Usuários</title>
    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background-color: #0b0b0b;
        color: #e0e0e0;
        margin: 0;
        padding: 20px;
      }

      h1 {
        color: #1db954;
        margin-bottom: 10px;
      }

      .info {
        margin-bottom: 16px;
        font-size: 14px;
        color: #aaaaaa;
        line-height: 1.4;
      }

      .card {
        border: 1px solid #222;
        background: #111;
        border-radius: 12px;
        padding: 14px;
        margin-bottom: 14px;
      }

      .row {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: end;
      }

      label {
        font-size: 12px;
        color: #bbbbbb;
        display: block;
        margin-bottom: 6px;
      }

      input {
        width: 260px;
        max-width: 100%;
        padding: 10px 10px;
        border-radius: 10px;
        border: 1px solid #2a2a2a;
        background: #0b0b0b;
        color: #e0e0e0;
        outline: none;
      }

      input:focus {
        border-color: #1db954;
      }

      button {
        padding: 10px 14px;
        border-radius: 10px;
        border: none;
        cursor: pointer;
        background-color: #1db954;
        color: #0b0b0b;
        font-weight: 800;
      }

      button.secondary {
        background: transparent;
        color: #e0e0e0;
        border: 1px solid #2a2a2a;
        font-weight: 700;
      }

      button.danger {
        background: #ff6b6b;
        color: #0b0b0b;
      }

      button:disabled {
        opacity: 0.6;
        cursor: default;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 12px;
        background-color: #111;
        border: 1px solid #222;
        border-radius: 12px;
        overflow: hidden;
      }

      th,
      td {
        padding: 10px 12px;
        border-bottom: 1px solid #222;
        font-size: 13px;
        vertical-align: top;
      }

      th {
        text-align: left;
        background-color: #151515;
      }

      tr:nth-child(even) {
        background-color: #141414;
      }

      .pill {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 999px;
        font-size: 12px;
        background-color: #1db954;
        color: #0b0b0b;
        font-weight: 800;
      }

      code {
        background: #0b0b0b;
        border: 1px solid #222;
        padding: 2px 6px;
        border-radius: 8px;
      }

      .muted {
        color: #9a9a9a;
      }

      .error {
        color: #ff6b6b;
        margin-top: 8px;
        font-size: 13px;
        white-space: pre-wrap;
      }
      .ok {
        color: #7cff9a;
        margin-top: 8px;
        font-size: 13px;
        white-space: pre-wrap;
      }

      .small {
        font-size: 12px;
      }
    </style>

    <!-- Supabase JS (browser) -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script>
      // ✅ Fixos (sem card de config)
      // ⚠️ A anon key é pública (ok estar aqui). NÃO coloque service-role aqui.
      const SUPABASE_URL = "https://douyjoogmnwjmfaudjke.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRvdXlqb29nbW53am1mYXVkamtlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU3MTk2MzgsImV4cCI6MjA4MTI5NTYzOH0.ryElWyHw424gZMOUH9C6MFEHKHWKw_xzlwod6xwZ_G0";
    </script>
  </head>
  <body>
    <h1>ORE – Administração de Usuários</h1>
    <p class="info">
      Painel de teste (local). Você precisa estar na tabela <code>public.admins</code> para executar ações.
      <span class="muted small">Dica: se der “Forbidden”, é porque seu usuário não é admin ainda.</span>
    </p>

    <div class="card" id="authCard">
      <div class="row">
        <div>
          <label>E-mail do admin</label>
          <input id="adminEmail" placeholder="seuemail@exemplo.com" />
        </div>
        <div>
          <label>Senha</label>
          <input id="adminPass" type="password" placeholder="sua senha" />
        </div>
        <button id="loginBtn">Entrar</button>
        <button id="logoutBtn" class="secondary" style="display: none">Sair</button>
        <div style="flex: 1"></div>
        <span id="sessionInfo" class="muted"></span>
      </div>
      <div class="error" id="authError"></div>
      <div class="ok" id="authOk"></div>
    </div>

    <div class="card" id="actionsCard" style="display: none">
      <div class="row">
        <button id="refreshBtn">Atualizar lista</button>
        <span id="statusText" class="muted"></span>
      </div>
      <hr style="border: none; border-top: 1px solid #222; margin: 14px 0" />

      <div class="row">
        <div>
          <label>Nome (novo usuário)</label>
          <input id="newName" placeholder="Usuário Teste" />
        </div>
        <div>
          <label>E-mail (novo usuário)</label>
          <input id="newEmail" placeholder="teste+1@exemplo.com" />
        </div>
        <div>
          <label>Senha (novo usuário)</label>
          <input id="newPass" placeholder="mínimo 6" />
        </div>
        <div>
          <label>Telefone (opcional)</label>
          <input id="newPhone" placeholder="(11) 99999-9999" />
        </div>
        <button id="createBtn">Criar usuário</button>
      </div>
      <div class="error" id="createError"></div>
      <div class="ok" id="createOk"></div>
    </div>

    <div class="error" id="errorText"></div>
    <div class="ok" id="okText"></div>

    <table id="usersTable" style="display: none">
      <thead>
        <tr>
          <th>Nome</th>
          <th>E-mail</th>
          <th>Telefone</th>
          <th>Créditos</th>
          <th>Criado em</th>
          <th>Último login</th>
          <th>ID</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody id="usersTableBody">
        <tr>
          <td colspan="8">Faça login para carregar.</td>
        </tr>
      </tbody>
    </table>

    <script>
      const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      let session = null;

      function $(id) {
        return document.getElementById(id);
      }
      function setText(id, txt) {
        $(id).textContent = txt || "";
      }
      function setErr(id, txt) {
        setText(id, txt);
      }
      function setOk(id, txt) {
        setText(id, txt);
      }

      function fnUrl() {
        const functionsBase = SUPABASE_URL.replace(".supabase.co", ".functions.supabase.co");
        // Padrão mais comum hoje:
        return `${functionsBase}/functions/v1/admin`;
      }

      async function callAdmin(method, path = "", body) {
        if (!session?.access_token) throw new Error("Sem sessão");
        const endpoint = fnUrl() + path;
        const res = await fetch(endpoint, {
          method,
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${session.access_token}`,
          },
          body: body ? JSON.stringify(body) : undefined,
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok || data?.ok === false) {
          throw new Error(data?.message || `Erro ${res.status}`);
        }
        return data;
      }

      async function login() {
        setErr("authError", "");
        setOk("authOk", "");
        try {
          const email = $("adminEmail").value.trim();
          const password = $("adminPass").value;
          if (!email || !password) throw new Error("Informe e-mail e senha do admin");

          const { data, error } = await sb.auth.signInWithPassword({ email, password });
          if (error || !data.session) throw new Error(error?.message || "Falha no login");

          session = data.session;

          $("loginBtn").style.display = "none";
          $("logoutBtn").style.display = "inline-block";
          $("actionsCard").style.display = "block";
          $("usersTable").style.display = "table";
          setText("sessionInfo", `Logado como: ${email}`);
          setOk("authOk", "Logado.");
          localStorage.setItem("ORE_ADMIN_EMAIL_LAST", email);

          await loadUsers();
        } catch (e) {
          console.error(e);
          setErr("authError", e.message || String(e));
        }
      }

      async function logout() {
        try {
          await sb.auth.signOut();
        } catch {}
        session = null;
        $("loginBtn").style.display = "inline-block";
        $("logoutBtn").style.display = "none";
        $("actionsCard").style.display = "none";
        setText("sessionInfo", "");
        $("usersTableBody").innerHTML = `<tr><td colspan="8">Faça login para carregar.</td></tr>`;
        setErr("authError", "");
        setOk("authOk", "");
      }

      async function loadUsers() {
        setErr("errorText", "");
        setOk("okText", "");
        $("refreshBtn").disabled = true;
        $("usersTableBody").innerHTML = `<tr><td colspan="8">Carregando...</td></tr>`;

        try {
          const data = await callAdmin("GET");
          const users = data.users || [];

          if (!users.length) {
            $("usersTableBody").innerHTML = `<tr><td colspan="8">Nenhum usuário.</td></tr>`;
          } else {
            $("usersTableBody").innerHTML = "";
            for (const u of users) {
              const tr = document.createElement("tr");

              const createdStr = u.createdAt ? new Date(u.createdAt).toLocaleString("pt-BR") : "";
              const lastStr = u.lastSignInAt ? new Date(u.lastSignInAt).toLocaleString("pt-BR") : "";

              tr.innerHTML = `
                <td>${u.name || ""}</td>
                <td>${u.email || ""}</td>
                <td>${u.phone || ""}</td>
                <td><span class="pill">${u.balance ?? 0}</span></td>
                <td>${createdStr}</td>
                <td class="muted">${lastStr || "-"}</td>
                <td class="muted small">${u.id}</td>
                <td>
                  <div class="row" style="gap:6px">
                    <button class="secondary" data-add="${u.id}">+10</button>
                    <button class="secondary" data-sub="${u.id}">-10</button>
                    <button class="danger" data-del="${u.id}">Excluir</button>
                  </div>
                </td>
              `;

              $("usersTableBody").appendChild(tr);
            }
          }

          setText(
            "statusText",
            "Última atualização: " + new Date().toLocaleTimeString("pt-BR", { hour12: false })
          );
        } catch (e) {
          console.error(e);
          setErr("errorText", e.message || String(e));
        } finally {
          $("refreshBtn").disabled = false;
        }
      }

      async function createUser() {
        setErr("createError", "");
        setOk("createOk", "");
        $("createBtn").disabled = true;

        try {
          const name = $("newName").value.trim();
          const email = $("newEmail").value.trim();
          const password = $("newPass").value;
          const phone = $("newPhone").value.trim();

          const data = await callAdmin("POST", "", {
            action: "create",
            name,
            email,
            password,
            phone,
          });

          setOk("createOk", `Usuário criado: ${data.user?.email || email}`);
          $("newEmail").value = "";
          $("newPass").value = "";
          await loadUsers();
        } catch (e) {
          console.error(e);
          setErr("createError", e.message || String(e));
        } finally {
          $("createBtn").disabled = false;
        }
      }

      async function adjust(userId, delta) {
        setErr("errorText", "");
        setOk("okText", "");
        try {
          const data = await callAdmin("POST", "", {
            action: "adjust_credits",
            userId,
            delta,
            reason: "admin_web",
          });
          setOk("okText", `Saldo atualizado: ${data.balance}`);
          await loadUsers();
        } catch (e) {
          console.error(e);
          setErr("errorText", e.message || String(e));
        }
      }

      async function delUser(userId) {
        if (!confirm("Excluir este usuário?")) return;
        setErr("errorText", "");
        setOk("okText", "");
        try {
          await callAdmin("DELETE", `?userId=${encodeURIComponent(userId)}`);
          setOk("okText", "Usuário excluído.");
          await loadUsers();
        } catch (e) {
          console.error(e);
          setErr("errorText", e.message || String(e));
        }
      }

      document.addEventListener("click", (ev) => {
        const t = ev.target;
        if (!(t instanceof HTMLElement)) return;

        const add = t.getAttribute("data-add");
        const sub = t.getAttribute("data-sub");
        const del = t.getAttribute("data-del");

        if (add) adjust(add, 10);
        if (sub) adjust(sub, -10);
        if (del) delUser(del);
      });

      $("loginBtn").addEventListener("click", login);
      $("logoutBtn").addEventListener("click", logout);
      $("refreshBtn").addEventListener("click", loadUsers);
      $("createBtn").addEventListener("click", createUser);

      // Pré-preenche o e-mail (pra você só digitar a senha)
      const last = localStorage.getItem("ORE_ADMIN_EMAIL_LAST") || "";
      if (last) $("adminEmail").value = last;
    </script>
  </body>
</html>
